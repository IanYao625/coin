<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yaoæ—…éŠè¨˜å¸³</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #228be6; --success: #40c057; --danger: #fa5252; --gray: #adb5bd; --bg-overlay: rgba(255, 255, 255, 0.9); }
        body { font-family: -apple-system, "Segoe UI", sans-serif; margin: 0; padding-bottom: 100px; color: #495057; 
               background: url('https://www.ourchinastory.com/images/cover/travel-leisure/2021/12/horizon/1466367375685521408.jpg') center/cover fixed; transition: 0.3s; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .card { background: var(--bg-overlay); backdrop-filter: blur(15px); border-radius: 24px; padding: 22px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.4); }
        .notice-card { background: #fff9db !important; border-left: 6px solid #fab005 !important; border-radius: 18px; padding: 15px; margin-top: 10px; }
        .trip-title { font-size: 1.6rem; font-weight: 900; color: #1c7ed6; border: none; background: none; width: 100%; text-align: center; outline: none; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e9ecef; border-radius: 14px; background: #fff; font-size: 1rem; box-sizing: border-box; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .check-item { background: #fff; padding: 12px; border-radius: 16px; border: 1px solid #eee; display: flex; align-items: center; cursor: pointer; transition: 0.2s; position: relative; }
        .check-item input[type="checkbox"] { width: 18px; height: 18px; margin-right: 10px; pointer-events: none; }
        .payer-input { width: 80px !important; padding: 5px !important; margin: 0 0 0 5px !important; font-size: 0.85rem !important; border-radius: 8px !important; text-align: right; }
        .primary-btn { background: linear-gradient(135deg, #4dabf7, #228be6); color: white; border: none; width: 100%; padding: 16px; border-radius: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .bottom-nav { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); display: flex; justify-content: space-around; padding: 12px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 100; }
        .nav-item { color: var(--gray); font-size: 0.75rem; text-align: center; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .page { display: none; } .page.active { display: block; }
        .bill-card { background: white; padding: 18px; border-radius: 20px; margin-bottom: 12px; border: 1px solid #f1f3f5; }
        .btn-sm { padding: 6px 12px; border-radius: 10px; font-size: 0.75rem; border: none; cursor: pointer; }
        /* æ¨™ç±¤é–“è·å„ªåŒ– */
        .badge { background: #f1f3f5; color: #495057; padding: 8px 14px; border-radius: 12px; font-size: 0.9rem; margin: 6px 4px; display: inline-block; border: 1px solid #e9ecef; }
    </style>
</head>
<body>

<div class="container">
    <div class="card" style="text-align:center;">
        <input type="text" id="tripTitle" class="trip-title" placeholder="æ—…ç¨‹åç¨±" onchange="updateTripTitle(this.value)">
        <div id="tripCurrencyBadge" style="font-weight:bold; color:var(--primary); margin-top:5px;"></div>
        <div class="notice-card"><textarea id="noticeContent" style="background:transparent; border:none; width:100%; height:45px; resize:none; outline:none;" placeholder="è¨˜éŒ„é£¯åº—ã€äº¤é€šç­‰é‡è¦è³‡è¨Š..." onchange="updateNotice(this.value)"></textarea></div>
    </div>

    <div id="page-add" class="page active">
        <div class="card">
            <h3>âœï¸ è¨˜ä¸€ç­†èŠ±è²» (<span id="currentCurrencyLabel"></span>)</h3>
            <input type="text" id="billDesc" placeholder="åƒäº†ä»€éº¼ã€è²·äº†ä»€éº¼ï¼Ÿ">
            <input type="number" id="billAmount" placeholder="è¼¸å…¥ç¸½é‡‘é¡">
            <label style="font-weight:bold; color:var(--primary);">ğŸ’° èª°å‡ºçš„éŒ¢ï¼Ÿ</label>
            <span style="font-size:0.75rem; color:var(--primary); cursor:pointer; float:right;" onclick="togglePayerMode()">[å¤šäººä»£å¢Šæ¨¡å¼]</span>
            <div id="singlePayerArea"><select id="billPayerSelect"></select></div>
            <div id="multiPayerArea" style="display:none;" class="grid-box"></div>
            <label style="display:block; margin-top:15px; font-weight:bold; color:var(--primary);">ğŸ‘¥ èª°åˆ†æ”¤ï¼Ÿ</label>
            <div style="margin-bottom:8px;"><button onclick="ui.toggleAllSplit(true)" class="btn-sm">å…¨é¸</button><button onclick="ui.toggleAllSplit(false)" class="btn-sm">å–æ¶ˆ</button></div>
            <div id="splitCheckboxes" class="grid-box"></div>
            <button class="primary-btn" onclick="api.addBill()">ç¢ºèªè¨˜å¸³ ğŸ“¥</button>
        </div>
    </div>

    <div id="page-history" class="page">
        <div class="card"><h3>ğŸ“œ æ—…ç¨‹æ˜ç´°</h3><div id="historyList"></div></div>
    </div>

    <div id="page-settle" class="page">
        <div class="card">
            <h3 style="text-align:center;">ğŸ“Š æ”¯å‡ºä½”æ¯” (<span id="chartCurLabel"></span>)</h3>
            <div style="width:70%; margin:0 auto;"><canvas id="spendChart"></canvas></div>
        </div>
        <div class="card"><h3>ğŸ’¸ çµç®—æ–¹æ¡ˆ</h3><div id="settlementResult"></div></div>
    </div>

    <div id="page-manage" class="page">
        <div class="card">
            <h3>ğŸ‘¥ æ—…ä¼´ç®¡ç†</h3>
            <div style="display:flex; gap:10px;"><input type="text" id="newMemberName" placeholder="åå­—"><button onclick="api.addMember()" class="btn-sm" style="background:var(--success); color:white;">æ–°å¢</button></div>
            <div id="memberList" style="margin-top:12px;"></div>
        </div>
        <div class="card"><h3>ğŸ“‚ æ­·å²æª”æ¡ˆåº«</h3><div id="archiveList"></div><button onclick="ui.showNewTripModal()" class="primary-btn" style="background:#495057;">ğŸ†• é–‹å•Ÿæ–°æ—…ç¨‹</button></div>
        <div class="card" style="border:1px dashed #ccc;">
            <button onclick="ui.showAdmin()" style="background:none; border:none; color:var(--gray); cursor:pointer; width:100%;">ğŸ› ï¸ é€²éšç³»çµ±è¨­å®š</button>
            <div id="adminPanel" style="display:none; margin-top:10px;">
                <input type="password" id="adminPassInput" placeholder="ç®¡ç†å¯†ç¢¼"><button onclick="api.verifyAdmin()" class="btn-sm" style="background:var(--primary); color:white; width:100%;">é©—è­‰</button>
                <div id="adminControls" style="display:none; margin-top:15px;">
                    <label>èƒŒæ™¯åœ– URLï¼š</label><input type="text" id="bgUrlInput" onchange="api.updateBg(this.value)">
                    <button onclick="api.updateAdminConfig()" class="btn-sm" style="background:var(--primary); color:white; width:100%;">å„²å­˜è®Šæ›´</button>
                    <hr><h4>ğŸ’° ç³»çµ±å¯ç”¨å¹£åˆ¥</h4><div id="currencyList"></div>
                    <div style="display:flex; gap:5px;"><input type="text" id="newCurName"><button onclick="api.addCurrency()" class="btn-sm">æ–°å¢</button></div>
                    <hr><button onclick="api.resetSystem()" style="background:#fff5f5; color:red; border:1px solid red; width:100%; padding:10px; border-radius:10px;">ğŸ”¥ åˆå§‹åŒ–è³‡æ–™</button>
                </div>
            </div>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="ui.switchPage('add', this)">âœï¸<br>è¨˜å¸³</div>
    <div class="nav-item" onclick="ui.switchPage('history', this)">ğŸ“œ<br>æ˜ç´°</div>
    <div class="nav-item" onclick="ui.switchPage('settle', this)">ğŸ“Š<br>çµç®—</div>
    <div class="nav-item" onclick="ui.switchPage('manage', this)">âš™ï¸<br>ç®¡ç†</div>
</nav>

<script>
    const firebaseConfig = { apiKey: "AIzaSyA0ihW3ZPIrEHLPay1_psV_qrUn9jqAtuU", authDomain: "babyhan-11286.firebaseapp.com", databaseURL: "https://babyhan-11286-default-rtdb.firebaseio.com", projectId: "babyhan-11286" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const DATA_ROOT = 'travelSystem_V11';
    const flags = { "TWD": "TWD ğŸ‡¹ğŸ‡¼", "JPY": "JPY ğŸ‡¯ğŸ‡µ", "KRW": "KRW ğŸ‡°ğŸ‡·", "USD": "USD ğŸ‡ºğŸ‡¸", "VND": "VND ğŸ‘‘", "HKD": "HKD ğŸ‡­ğŸ‡°" };
    
    let currentTripId = "default", state = { title: "", members: [], bills: [], notice: "", tripCurrency: "TWD" }, 
        sysConfig = { bgUrl: "", currencies: ["TWD", "JPY", "KRW"], adminPass: "0000", passHint: "0000" },
        isMultiPayer = false, chartInstance = null;

    function handleBoxClick(e) { if(e.target.tagName === 'INPUT') return; const chk = e.currentTarget.querySelector('input[type="checkbox"]'); if(chk) chk.checked = !chk.checked; }

    const api = {
        addBill: () => {
            const desc = document.getElementById('billDesc').value, amount = parseFloat(document.getElementById('billAmount').value);
            if(!desc || isNaN(amount)) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Šï¼");
            let payers = {};
            if(!isMultiPayer) {
                payers[document.getElementById('billPayerSelect').value] = amount;
            } else {
                let total = 0;
                document.querySelectorAll('.payer-row').forEach(row => {
                    const chk = row.querySelector('input[type="checkbox"]');
                    const val = parseFloat(row.querySelector('.payer-input').value) || 0;
                    if(chk.checked && val > 0) { payers[chk.value] = val; total += val; }
                });
                if(Math.abs(total - amount) > 0.1) return alert("ä»£ä»˜ç¸½é¡ä¸ç¬¦ï¼");
            }
            const splitBetween = Array.from(document.querySelectorAll('input[name="sMember"]:checked')).map(el => el.value);
            if(Object.keys(payers).length === 0 || splitBetween.length === 0) return alert("è¦å‹¾é¸äººå“¡ï¼");
            state.bills.push({ desc, amount, currency: state.tripCurrency, payers, splitBetween, time: `${new Date().getMonth()+1}/${new Date().getDate()} ${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2,'0')}` });
            api.saveState();
            document.getElementById('billDesc').value = ''; document.getElementById('billAmount').value = '';
        },
        clearDebt: (f, t, a) => {
            if(confirm(`ç¢ºèªçµæ¸… ${a}ï¼Ÿ`)) {
                let p = {}; p[f] = a;
                state.bills.push({ desc: `âœ… çµæ¸… (${f}â”${t})`, amount: a, currency: state.tripCurrency, payers: p, splitBetween: [t], time: "å‰›å‰›" });
                api.saveState();
            }
        },
        saveState: () => db.ref(`${DATA_ROOT}/trips/${currentTripId}`).set(state),
        saveConfig: () => db.ref(`${DATA_ROOT}/config`).set(sysConfig),
        addMember: () => { const n = document.getElementById('newMemberName').value.trim(); if(n) { state.members.push(n); api.saveState(); document.getElementById('newMemberName').value=''; } },
        removeMember: (i) => { if(confirm("ç§»é™¤æ—…ä¼´ï¼Ÿ")) { state.members.splice(i,1); api.saveState(); } },
        addCurrency: () => { const n = document.getElementById('newCurName').value.trim().toUpperCase(); if(n && !sysConfig.currencies.includes(n)) { sysConfig.currencies.push(n); api.saveConfig(); } },
        removeCurrency: (k) => { if(confirm(`ä¸ä½¿ç”¨ ${k}ï¼Ÿ`)) { sysConfig.currencies = sysConfig.currencies.filter(c => c !== k); api.saveConfig(); } },
        verifyAdmin: () => { if(document.getElementById('adminPassInput').value === sysConfig.adminPass) document.getElementById('adminControls').style.display = 'block'; else alert("å¯†ç¢¼éŒ¯èª¤ï¼"); },
        updateAdminConfig: () => { api.saveConfig(); alert("å·²å„²å­˜ï¼"); },
        deleteTripArchive: (id) => { if(confirm("åˆªé™¤æ­·å²ï¼Ÿ")) { db.ref(`${DATA_ROOT}/archives/${id}`).remove(); db.ref(`${DATA_ROOT}/trips/${id}`).remove(); } },
        resetSystem: () => { if(confirm("ğŸ”¥ ç¢ºå®šåˆå§‹åŒ–ï¼Ÿ")) db.ref(DATA_ROOT).remove().then(()=>location.reload()); },
        updateBg: (url) => { sysConfig.bgUrl = url; api.saveConfig(); }
    };

    const ui = {
        render: (archives) => {
            document.getElementById('tripTitle').value = state.title;
            document.getElementById('noticeContent').value = state.notice || "";
            document.getElementById('tripCurrencyBadge').innerHTML = `ğŸŒ çµç®—å¹£ç¨®ï¼š${flags[state.tripCurrency] || state.tripCurrency}`;
            document.getElementById('currentCurrencyLabel').innerText = state.tripCurrency;
            document.getElementById('chartCurLabel').innerText = state.tripCurrency;
            document.body.style.backgroundImage = `url('${sysConfig.bgUrl}')`;
            document.getElementById('billPayerSelect').innerHTML = (state.members || []).map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('multiPayerArea').innerHTML = (state.members || []).map(m => `
                <div class="check-item payer-row" onclick="handleBoxClick(event)">
                    <input type="checkbox" value="${m}">
                    <span>${m}</span>
                    <input type="number" class="payer-input" placeholder="ä»£ä»˜" onclick="event.stopPropagation()">
                </div>`).join('');
            document.getElementById('splitCheckboxes').innerHTML = (state.members || []).map(m => `<div class="check-item" onclick="handleBoxClick(event)"><input type="checkbox" name="sMember" value="${m}" checked><span>${m}</span></div>`).join('');
            document.getElementById('memberList').innerHTML = (state.members || []).map((m, i) => `<span class="badge">${m} <small onclick="api.removeMember(${i})" style="color:red; cursor:pointer;">Ã—</small></span>`).join('');
            document.getElementById('historyList').innerHTML = (state.bills || []).slice().reverse().map((b, i) => {
                const idx = state.bills.length - 1 - i;
                return `<div class="bill-card">
                    <div style="display:flex; justify-content:space-between;">
                        <div><b>${b.desc}</b><br><small>ä»£å¢Šï¼š${Object.entries(b.payers).map(([n,v])=>`${n}(${v})`).join(',')}</small></div>
                        <div style="text-align:right"><b>${b.amount} ${b.currency}</b><br>
                        <button class="btn-sm" onclick="ui.editBill(${idx})">ğŸ“</button>
                        <button class="btn-sm" style="color:red;" onclick="ui.deleteBill(${idx})">ğŸ—‘ï¸</button></div>
                    </div>
                </div>`}).join('');
            document.getElementById('archiveList').innerHTML = Object.keys(archives).map(id => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#fff; border-radius:14px; margin-bottom:8px;">
                    <span><b>${archives[id]}</b></span>
                    <div><button onclick="api.loadTrip('${id}')" class="btn-sm" style="background:var(--primary); color:white;">è¼‰å…¥</button>
                    <button onclick="api.deleteTripArchive('${id}')" class="btn-sm" style="color:var(--danger); background:none;">ğŸ—‘ï¸</button></div>
                </div>`).join('');
            document.getElementById('currencyList').innerHTML = sysConfig.currencies.map(k => `<div style="display:flex; justify-content:space-between;"><span>${flags[k]||k}</span><button onclick="api.removeCurrency('${k}')" style="color:red; border:none; background:none;">[åˆªé™¤]</button></div>`).join('');
        },
        showNewTripModal: () => {
            const name = prompt("æ—…ç¨‹åç¨±ï¼š"); if(!name) return;
            const cur = prompt(`å¹£ç¨®ä»£ç¢¼ (${sysConfig.currencies.join(", ")})ï¼š`, "TWD").toUpperCase();
            if(!sysConfig.currencies.includes(cur)) return alert("è«‹å…ˆåœ¨å¾Œå°æ–°å¢è©²å¹£ç¨®ï¼");
            const id = "trip_" + Date.now();
            db.ref(`${DATA_ROOT}/currentTripId`).set(id);
            db.ref(`${DATA_ROOT}/archives/${id}`).set(name);
            db.ref(`${DATA_ROOT}/trips/${id}`).set({ title: name, members: [], bills: [], notice: "", tripCurrency: cur });
        },
        toggleAllSplit: (v) => document.querySelectorAll('input[name="sMember"]').forEach(c => c.checked = v),
        switchPage: (p, el) => {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active');
            if(p === 'settle') ui.calculateSettlement();
        },
        calculateSettlement: () => {
            const res = document.getElementById('settlementResult'); res.innerHTML = '';
            const chartData = {}; state.members.forEach(m => chartData[m] = 0);
            const balances = {}; state.members.forEach(m => balances[m] = 0);
            (state.bills || []).forEach(b => {
                const sAmt = b.amount / b.splitBetween.length;
                for(let p in b.payers) { balances[p] += b.payers[p]; }
                b.splitBetween.forEach(m => { balances[m] -= sAmt; if(!b.desc.includes("âœ… çµæ¸…")) chartData[m] += sAmt; });
            });
            let creditors = [], debtors = [];
            for (let m in balances) { if (balances[m] > 0.01) creditors.push({n: m, a: balances[m]}); else if (balances[m] < -0.01) debtors.push({n: m, a: Math.abs(balances[m])}); }
            debtors.forEach(d => creditors.forEach(c => {
                let pay = Math.min(d.a, c.a);
                if(pay > 0.01) {
                    res.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;"><span>${d.n} â” ${c.n} <b>${pay.toFixed(2)}</b></span><button class="btn-sm" style="background:var(--success); color:white;" onclick="api.clearDebt('${d.n}','${c.n}',${pay.toFixed(2)})">çµæ¸…</button></div>`;
                    d.a -= pay; c.a -= pay;
                }
            }));
            ui.updateChart(chartData);
        },
        updateChart: (data) => {
            const ctx = document.getElementById('spendChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#ff6b6b', '#4dabf7', '#63e6be', '#fab005', '#94d82d', '#7950f2'] }] } });
        },
        editBill: (i) => {
            const b = state.bills[i];
            const newAmt = prompt(`æ­£åœ¨ç·¨è¼¯ã€Œ${b.desc}ã€çš„é‡‘é¡\nç›®å‰ç‚ºï¼š${b.amount}`, b.amount);
            if(newAmt && !isNaN(newAmt)) {
                const updatedAmt = Number(parseFloat(newAmt).toFixed(2));
                if(Object.keys(b.payers).length > 1) { alert("å¤šäººä»˜æ¬¾å»ºè­°åˆªé™¤é‡è¨˜ã€‚"); return; }
                b.payers[Object.keys(b.payers)[0]] = updatedAmt;
                b.amount = updatedAmt;
                api.saveState();
            }
        },
        deleteBill: (i) => { if(confirm("åˆªé™¤æ­¤å¸³ç›®ï¼Ÿ")) { state.bills.splice(i,1); api.saveState(); } },
        showAdmin: () => { const p = document.getElementById('adminPanel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    };

    db.ref(DATA_ROOT).on('value', (s) => {
        const val = s.val() || {}; currentTripId = val.currentTripId || "default";
        if(val.config) sysConfig = { ...sysConfig, ...val.config };
        state = (val.trips && val.trips[currentTripId]) ? val.trips[currentTripId] : { title: "", members: [], bills: [], notice: "", tripCurrency: "TWD" };
        if(!state.bills) state.bills = []; if(!state.members) state.members = [];
        ui.render(val.archives || {});
    });

    function togglePayerMode() { isMultiPayer = !isMultiPayer; document.getElementById('singlePayerArea').style.display = isMultiPayer ? 'none' : 'block'; document.getElementById('multiPayerArea').style.display = isMultiPayer ? 'grid' : 'none'; }
    function updateTripTitle(v) { state.title = v; db.ref(`${DATA_ROOT}/archives/${currentTripId}`).set(v); api.saveState(); }
    function updateNotice(v) { state.notice = v; api.saveState(); }
    api.loadTrip = (id) => db.ref(`${DATA_ROOT}/currentTripId`).set(id);
</script>
</body>
</html>