<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yao æ—…éŠè¨˜å¸³</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #228be6; --success: #40c057; --danger: #fa5252; --gray: #adb5bd; --light-gray: #e9ecef; --bg-overlay: rgba(255, 255, 255, 0.9); }
        body { font-family: -apple-system, "Segoe UI", sans-serif; margin: 0; padding-bottom: 120px; color: #495057; 
               background: url('https://www.ourchinastory.com/images/cover/travel-leisure/2021/12/horizon/1466367375685521408.jpg') center/cover fixed; transition: 0.3s; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .card { background: var(--bg-overlay); backdrop-filter: blur(10px); border-radius: 25px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .notice-card { background: #fff9db !important; border-left: 8px solid #fcc419 !important; color: #856404; text-align: center; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1rem; box-sizing: border-box; }
        .primary-btn { background: linear-gradient(135deg, #4dabf7, #228be6); color: white; border: none; width: 100%; padding: 15px; border-radius: 15px; font-weight: bold; cursor: pointer; }
        .history-card { background: white; border-radius: 20px; padding: 18px; margin-bottom: 15px; border-left: 6px solid var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
        .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .history-title { font-size: 1.1rem; font-weight: 800; color: #333; }
        .history-amount { font-size: 1.2rem; font-weight: 900; color: var(--primary); }
        .history-meta { font-size: 0.8rem; color: #adb5bd; margin-bottom: 10px; display: flex; gap: 10px; }
        .history-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px; }
        .tag-pill { font-size: 0.75rem; padding: 3px 10px; border-radius: 20px; background: #f1f3f5; color: #495057; }
        .tag-pill.payer { background: #e7f5ff; color: #228be6; font-weight: bold; }
        .history-actions { display: flex; gap: 10px; border-top: 1px solid #f1f3f5; padding-top: 10px; }
        .action-btn { flex: 1; border: none; background: none; font-size: 0.85rem; font-weight: bold; cursor: pointer; padding: 5px; border-radius: 8px; transition: 0.2s; }
        .edit-btn { color: var(--primary); background: #e7f5ff; }
        .del-btn { color: var(--danger); background: #fff5f5; }
        .cur-tag { padding: 8px 12px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; background: var(--light-gray); color: #888; display: inline-block; margin: 2px; transition: 0.2s; font-size: 0.9rem; }
        .cur-tag.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }
        .collapse-panel { display: none; margin-top: 10px; background: rgba(0,0,0,0.05); padding: 15px; border-radius: 15px; border: 1px solid #ddd; }
        .bottom-nav { position: fixed; bottom: 15px; left: 15px; right: 15px; background: white; display: flex; padding: 10px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { text-align: center; flex: 1; color: #adb5bd; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item b { font-size: 1.4rem; display: block; }
        .page { display: none; } .page.active { display: block; }
        #login-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #1c7ed6, #1098ad); z-index: 5000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .select-all-btn { background: none; border: 1px solid var(--primary); color: var(--primary); border-radius: 8px; padding: 4px 10px; font-size: 0.75rem; cursor: pointer; float: right; }
        .footer-version { text-align: center; font-size: 0.75rem; color: #ced4da; margin-top: 30px; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="card" style="width: 100%; max-width: 400px; text-align: center;">
        <h2 style="color: var(--primary); margin-bottom: 5px;">âœˆï¸ Yao æ—…éŠè¨˜å¸³</h2>
        <p style="font-size: 0.85rem; color: var(--gray); margin-bottom: 20px;">æº–å‚™å¥½é–‹å•Ÿé€™è¶Ÿæ•—å®¶æ—…ç¨‹äº†å—ï¼Ÿ</p>
        <div id="roomListArea" style="margin-bottom: 15px; display: flex; flex-wrap: wrap; justify-content: center;"></div>
        <input type="text" id="roomNameInput" placeholder="æƒ³å»å“ªå€‹ä¸–ç•Œå†’éšªï¼Ÿ" oninput="api.checkRoom()">
        <input type="password" id="roomPassInput" placeholder="è¼¸å…¥é€²å…¥ç©ºé–“çš„é€šé—œå¯†èª">
        <div id="newRoomSetup" style="display: none; margin-top: 10px;">
            <p style="font-size: 0.85rem; font-weight: bold; color: var(--primary);">ğŸŒŸ æ­¡è¿ä¾†åˆ°æ–°æ¬¡å…ƒï¼è«‹é¸æ“‡ä¸»å¹£åˆ¥ï¼š</p>
            <div id="loginCurList"></div>
        </div>
        <button class="primary-btn" onclick="api.initRoom()" style="margin-top: 20px;">é–‹å•Ÿå‚³é€é–€ â”</button>
        <p id="roomHintTxt" style="color: var(--danger); font-size: 0.8rem; margin-top: 10px; font-weight: bold;"></p>
    </div>
</div>

<div class="container" id="main-content" style="display: none;">
    <div class="card notice-card">
        <input type="text" id="tripTitle" style="font-size: 1.4rem; font-weight: bold; text-align: center; border: none; background: none; color: inherit; width: 100%; margin-bottom:0;" onchange="api.saveState()">
        <div id="tripCurBadge" style="text-align: center; font-size: 0.75rem; opacity: 0.6; margin-top: 5px;"></div>
        <textarea id="noticeContent" style="background: none; border: none; font-size: 0.9rem; margin-top: 10px; color: inherit; width: 100%; text-align: center;" placeholder="åœ¨é€™è£¡å¯«ä¸‹æ—…è¡Œçš„å°å®åš€æˆ–æ•—å®¶æ¸…å–®..." onchange="api.saveState()"></textarea>
    </div>

    <div id="page-add" class="page active">
        <div class="card">
            <h3 id="addBillTitle">âœï¸ æ•—å®¶ç­†è¨˜</h3>
            <input type="text" id="billDesc" placeholder="å‰›æ‰è²·äº†ä»€éº¼å¥½æ±è¥¿ï¼Ÿ">
            <input type="number" id="billAmount" placeholder="åˆ·äº†å¤šå°‘éŒ¢ï¼Ÿ(ä¸è¦çœ‹å¿ƒæœƒç—›)">
            <textarea id="billNote" placeholder="ç•¶æ™‚çš„å¿ƒæƒ…æˆ–æ˜¯çµ¦é€™ç­†éŒ¢æ‰¾å€‹è—‰å£..."></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                <span style="font-size: 0.9rem; font-weight: bold; color: var(--primary);">èª°æ˜¯ä»˜éŒ¢çš„å‹‡è€…ï¼Ÿ</span>
                <button onclick="togglePayerMode()" style="border: none; background: none; color: var(--primary); cursor: pointer; font-size: 0.8rem;">ğŸ”„ å¤šäººå…±åŒåˆ†æ“”</button>
            </div>
            <div id="singlePayerArea"><select id="billPayerSelect"></select></div>
            <div id="multiPayerArea" style="display: none; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
            <div style="margin-top: 15px; margin-bottom: 10px; overflow: hidden;"><span style="font-weight: bold; font-size: 0.9rem;">ğŸ‘¥ èª°è¦è¢«ä½ æ‹–ä¸‹æ°´ï¼Ÿ</span><button class="select-all-btn" onclick="ui.toggleAllSplit(true)">å…¨é¸</button><button class="select-all-btn" style="margin-right:5px;" onclick="ui.toggleAllSplit(false)">æ¸…ç©º</button></div>
            <div id="splitCheckboxes" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
            <button class="primary-btn" id="submitBillBtn" onclick="api.addBill()" style="margin-top: 20px;">å­˜å…¥æ­·å²æª”æ¡ˆ ğŸ“¥</button>
            <button class="primary-btn" id="cancelEditBtn" onclick="ui.cancelEdit()" style="margin-top: 10px; background: #868e96; display:none;">é¥’äº†ä»–ï¼Œå–æ¶ˆç·¨è¼¯</button>
        </div>
    </div>

    <div id="page-history" class="page">
        <div id="historyList"></div>
    </div>

    <div id="page-settle" class="page">
        <div class="card" style="text-align: center;"><h3>ğŸ“Š è²¡å¯Œæµå‘åœ–</h3><canvas id="spendChart"></canvas></div>
        <div class="card"><h3>ğŸ’¸ èª°è©²é‚„éŒ¢è¶•å¿«è¬›</h3><div id="settlementResult"></div><hr><button class="primary-btn" style="background: var(--success);" onclick="api.settleAll()">æ•´è¶Ÿæ—…ç¨‹çµæ¸…ï¼ˆé‡æ–°æŠ•èƒï¼‰ â”</button></div>
    </div>

    <div id="page-manage" class="page">
        <div class="card"><h4 style="margin:0 0 10px 0;">ğŸ“‚ å¹³è¡Œæ—…è¡Œç©ºé–“</h4><div id="archiveList"></div><button onclick="ui.openNewTripModal()" class="primary-btn" style="background: #495057; margin-top: 10px; padding:8px;">ğŸ†• é–‹å•Ÿæ–°æ—…ç¨‹</button></div>
        <div class="card"><h3>ğŸ‘¥ åŒè¡Œå†¤å¤§é ­</h3><div style="display: flex; gap: 10px;"><input type="text" id="newMemberName" placeholder="æ—…ä¼´ç¶½è™Ÿ"><button onclick="api.addMember()" style="padding:0 15px; border-radius:10px; border:none; background:var(--primary); color:white; cursor:pointer;">åŠ å…¥</button></div><div id="memberList" style="margin-top: 10px;"></div></div>
        <div class="card"><button onclick="ui.togglePanel('roomLoginPanel')" style="width: 100%; border: none; background: none; font-weight: bold; color: var(--primary); text-align: left; padding:0;">ğŸ” ç©ºé–“å®‰å…¨æ€§è¨­ç½®</button><div id="roomLoginPanel" class="collapse-panel"><label>ä¿®æ”¹ç©ºé–“å¯†ç¢¼:</label><input type="text" id="editRoomPass" onchange="api.saveRoomConfig()"><label>å¯†ç¢¼æš—ç¤º:</label><input type="text" id="editRoomHint" onchange="api.saveRoomConfig()"></div></div>
        <div class="card" style="border: 2px solid #ffc9c9;"><button onclick="ui.accessAdmin()" style="width: 100%; border: none; background: none; font-weight: bold; color: var(--danger); text-align: left; padding:0;">ğŸ› ï¸ å…¨ç³»çµ±ç®¡ç†å¾Œå°</button><div id="sysConfigPanel" class="collapse-panel"><h3 style="color:var(--danger); margin-top:0;">ğŸ’€ ä¸–ç•Œæ¯€æ»…æ¸…å–®</h3><div id="globalSystemList"></div><hr><label>ğŸ–¼ï¸ èƒŒæ™¯ç¶²å€:</label><input type="text" id="editBgUrl" onchange="api.saveRoomConfig()"><label>ğŸ” ç³»çµ±æ¬Šé™å¯†é‘°:</label><input type="text" id="editAdminPass" onchange="api.saveRoomConfig()"><label>ğŸ’° æ–°å¢å¯ç”¨å¹£åˆ¥:</label><div style="display: flex; gap: 5px;"><input type="text" id="newCurInput" placeholder="å¦‚: KRW"><button onclick="api.addCurrency()">æ–°å¢</button></div><div id="curLabelArea" style="margin-top: 10px;"></div></div></div>
        <button onclick="location.reload()" class="primary-btn" style="background: #868e96; margin-top: 10px;">ğŸšª é€€å‡ºç›®å‰æ¬¡å…ƒ</button>
    </div>

    <div class="footer-version">V83.92 Stability Edition</div>
</div>

<div id="trip-modal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 20px;">
    <div class="card" style="width: 100%; max-width: 380px; text-align: center;">
        <h3>ğŸŒŸ ä¸‹ä¸€ç«™å»å“ªï¼Ÿ</h3><input type="text" id="newTripNameInput" placeholder="æ–°çš„æ—…ç¨‹åç¨±"><p style="font-weight: bold; margin-top: 10px;">çµç®—å¹£åˆ¥ï¼š</p><div id="modalCurList"></div><button class="primary-btn" onclick="api.createNewTrip()" style="margin-top: 20px;">å‡ºç™¼ â”</button><button onclick="document.getElementById('trip-modal').style.display='none'" style="margin-top: 10px; background:none; border:none; color:gray;">å¾…åœ¨åŸåœ°</button>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="ui.switchPage('add', this)"><b>âœï¸</b>æ•—å®¶</div>
    <div class="nav-item" onclick="ui.switchPage('history', this)"><b>ğŸ“œ</b>å›æ†¶</div>
    <div class="nav-item" onclick="ui.settleClick(this)"><b>ğŸ“Š</b>ç®—å¸³</div>
    <div class="nav-item" onclick="ui.switchPage('manage', this)"><b>âš™ï¸</b>è¨­ç½®</div>
</nav>

<script>
    const firebaseConfig = { apiKey: "AIzaSyA0ihW3ZPIrEHLPay1_psV_qrUn9jqAtuU", authDomain: "babyhan-11286.firebaseapp.com", databaseURL: "https://babyhan-11286-default-rtdb.firebaseio.com", projectId: "babyhan-11286" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const DATA_ROOT = 'travelSystem_V32';

    let roomKey = "", currentTripId = "default", isMultiPayer = false, myChart = null, selCur = "TWD", editingIdx = null, isRendering = false;
    let roomData = { pass: "0000", hint: "0000", adminPass: "0625", config: { bgUrl: "", currencies: ["TWD","JPY","USD"] }, trips: {}, archives: {}, currentTripId: "default" };
    let allRooms = {};

    const getSafeKey = (str) => btoa(encodeURIComponent(str));

    db.ref(DATA_ROOT).on('value', s => {
        allRooms = s.val() || {};
        const area = document.getElementById('roomListArea');
        if(area) area.innerHTML = Object.keys(allRooms).map(k => {
            let decoded = "æœªçŸ¥ä¸–ç•Œ";
            try { decoded = decodeURIComponent(atob(k)); } catch(e){}
            return `<div class="cur-tag" style="background:white; color:var(--primary);" onclick="document.getElementById('roomNameInput').value='${decoded}'; api.checkRoom()">${decoded}</div>`;
        }).join('');
    });

    const api = {
        attachRoomListener: () => {
            if(!roomKey) return;
            db.ref(`${DATA_ROOT}/${roomKey}`).off();
            db.ref(`${DATA_ROOT}/${roomKey}`).on('value', s => {
                const d = s.val();
                if(d) {
                    roomData = d;
                    currentTripId = roomData.currentTripId || "default";
                    const state = (roomData.trips && roomData.trips[currentTripId]) ? roomData.trips[currentTripId] : null;
                    if (state) { ui.render(state); ui.calcSettlement(state); }
                    if(roomData.config?.bgUrl) document.body.style.backgroundImage = `url('${roomData.config.bgUrl}')`;
                }
            });
        },
        checkRoom: () => {
            const name = document.getElementById('roomNameInput').value.trim();
            const rKey = getSafeKey(name);
            const existingRoom = allRooms[rKey];
            
            // --- æ ¸å¿ƒä¿®æ­£ï¼šå‹•æ…‹æƒæç³»çµ±å…§æ‰€æœ‰çš„è‡ªå®šç¾©å¹£åˆ¥ ---
            let availableCurs = ["TWD", "JPY", "USD"];
            
            // å¾ allRooms ä¸­å°‹æ‰¾æœ€æ–°çš„ç³»çµ±å¹£åˆ¥é…ç½®ï¼Œé€™èƒ½ç¢ºä¿åªè¦å¾Œå°æ–°å¢éï¼Œç™»å…¥é å°±èƒ½è®€åˆ°
            for (let key in allRooms) {
                if (allRooms[key].config && allRooms[key].config.currencies) {
                    availableCurs = allRooms[key].config.currencies;
                    break; 
                }
            }

            document.getElementById('newRoomSetup').style.display = (name && !existingRoom) ? 'block' : 'none';
            const curHTML = availableCurs.map(c => `<div class="cur-tag ${selCur===c?'active':''}" onclick="selCur='${c}'; api.checkRoom()">${c}</div>`).join('');
            
            if(document.getElementById('loginCurList')) document.getElementById('loginCurList').innerHTML = curHTML;
            if(document.getElementById('modalCurList')) document.getElementById('modalCurList').innerHTML = curHTML;
        },
        initRoom: () => {
            const name = document.getElementById('roomNameInput').value.trim();
            const pass = document.getElementById('roomPassInput').value.trim();
            if(!name || !pass) return;
            roomKey = getSafeKey(name);
            db.ref(`${DATA_ROOT}/${roomKey}`).once('value', s => {
                const d = s.val();
                if(d) {
                    if(d.pass !== pass) return document.getElementById('roomHintTxt').innerText = "æç¤ºï¼š" + (d.hint || "å¯†ç¢¼éŒ¯èª¤");
                    roomData = d; api.attachRoomListener(); enterUI();
                } else {
                    // å‰µå»ºæ–°æˆ¿é–“æ™‚ï¼Œç¹¼æ‰¿ç³»çµ±æœ€æ–°çš„å¹£åˆ¥é…ç½®
                    let latestCurs = ["TWD","JPY","USD"];
                    for (let key in allRooms) { if (allRooms[key].config?.currencies) { latestCurs = allRooms[key].config.currencies; break; } }
                    
                    const initialData = { pass, hint: "0000", adminPass: "0625", currentTripId: "default", config: { bgUrl: "", currencies: latestCurs }, archives: { "default": name }, trips: { "default": { title: name, members: [], bills: [], tripCurrency: selCur, notice: "" } } };
                    db.ref(`${DATA_ROOT}/${roomKey}`).set(initialData).then(() => { roomData = initialData; api.attachRoomListener(); enterUI(); });
                }
            });
        },
        saveState: () => {
            if (isRendering || !roomKey) return;
            const state = roomData.trips[currentTripId];
            if(state) {
                state.title = document.getElementById('tripTitle').value;
                state.notice = document.getElementById('noticeContent').value;
                db.ref(`${DATA_ROOT}/${roomKey}/trips/${currentTripId}`).update({ title: state.title, notice: state.notice });
            }
        },
        saveRoomConfig: () => {
            if (isRendering || !roomKey) return;
            roomData.pass = document.getElementById('editRoomPass').value || "0000";
            roomData.hint = document.getElementById('editRoomHint').value || "0000";
            roomData.adminPass = document.getElementById('editAdminPass').value || "0625";
            roomData.config.bgUrl = document.getElementById('editBgUrl').value;
            db.ref(`${DATA_ROOT}/${roomKey}`).update({ pass: roomData.pass, hint: roomData.hint, adminPass: roomData.adminPass, config: roomData.config });
        },
        addBill: () => {
            const state = roomData.trips[currentTripId];
            const desc = document.getElementById('billDesc').value, amt = parseFloat(document.getElementById('billAmount').value);
            if(!desc || (isNaN(amt))) return;
            let payers = {};
            if(isMultiPayer) { document.querySelectorAll('.multi-payer-input').forEach(el => { if(parseFloat(el.value)>0) payers[el.dataset.name] = parseFloat(el.value); }); }
            else { payers[document.getElementById('billPayerSelect').value] = amt; }
            const splitBetween = Array.from(document.querySelectorAll('input[name="splitMember"]:checked')).map(el => el.value);
            if(splitBetween.length === 0) return alert("è‡³å°‘é¸ä¸€å€‹æ—…ä¼´å¹«ä½ åˆ†æ“”å§ï¼");
            const newBill = { desc, amount: amt, note: document.getElementById('billNote').value, payers, splitBetween, time: editingIdx !== null ? state.bills[editingIdx].time : new Date().toLocaleString() };
            if(editingIdx !== null) { state.bills[editingIdx] = newBill; editingIdx = null; } 
            else { if(!state.bills) state.bills = []; state.bills.push(newBill); }
            db.ref(`${DATA_ROOT}/${roomKey}/trips/${currentTripId}/bills`).set(state.bills);
            ui.cancelEdit();
        },
        deleteBill: (idx) => { if(confirm("é€™ç­†é–‹éŠ·è¦å¾æ­·å²ä¸­æŠ¹é™¤å—ï¼Ÿ")) { roomData.trips[currentTripId].bills.splice(idx, 1); db.ref(`${DATA_ROOT}/${roomKey}/trips/${currentTripId}/bills`).set(roomData.trips[currentTripId].bills); } },
        addMember: () => {
            const n = document.getElementById('newMemberName').value.trim();
            if(n) { if(!roomData.trips[currentTripId].members) roomData.trips[currentTripId].members = []; roomData.trips[currentTripId].members.push(n); db.ref(`${DATA_ROOT}/${roomKey}/trips/${currentTripId}/members`).set(roomData.trips[currentTripId].members); document.getElementById('newMemberName').value = ''; }
        },
        createNewTrip: () => {
            const name = document.getElementById('newTripNameInput').value.trim(); if(!name) return;
            const newId = "trip_" + Date.now();
            if(!roomData.archives) roomData.archives = {};
            roomData.archives[newId] = name;
            roomData.trips[newId] = { title: name, members: roomData.trips[currentTripId].members || [], bills: [], notice: "", tripCurrency: selCur };
            roomData.currentTripId = newId;
            db.ref(`${DATA_ROOT}/${roomKey}`).update({ archives: roomData.archives, trips: roomData.trips, currentTripId: newId }).then(() => document.getElementById('trip-modal').style.display = 'none');
        },
        deleteGlobalRoom: (k) => { if(confirm("ç¢ºå®šè¦éŠ·æ¯€æ­¤ç©ºé–“å—ï¼Ÿè³‡æ–™æœƒæ°¸é æ¶ˆå¤±å–”ï¼")) db.ref(`${DATA_ROOT}/${k}`).remove(); },
        addCurrency: () => { const c = document.getElementById('newCurInput').value.trim().toUpperCase(); if(c && !roomData.config.currencies.includes(c)) { roomData.config.currencies.push(c); api.saveRoomConfig(); document.getElementById('newCurInput').value = ''; } },
        deleteCurrency: (c) => { roomData.config.currencies = roomData.config.currencies.filter(item => item !== c); api.saveRoomConfig(); },
        settleAll: () => { if(confirm("æ•´è¶Ÿçµæ¡ˆå°‡æ¸…ç©ºæ‰€æœ‰å¸³ç›®ï¼Œç¢ºå®šè¦æ­¸é›¶äººç”Ÿå—ï¼Ÿ")) { db.ref(`${DATA_ROOT}/${roomKey}/trips/${currentTripId}/bills`).set([]); } }
    };

    function enterUI() { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('main-content').style.display = 'block'; }
    function togglePayerMode() { isMultiPayer = !isMultiPayer; document.getElementById('singlePayerArea').style.display = isMultiPayer ? 'none' : 'block'; document.getElementById('multiPayerArea').style.display = isMultiPayer ? 'grid' : 'none'; }

    const ui = {
        render: (state) => {
            isRendering = true;
            document.getElementById('tripTitle').value = state.title || "";
            document.getElementById('noticeContent').value = state.notice || "";
            document.getElementById('tripCurBadge').innerText = "çµç®—ä¸»å¹£åˆ¥ï¼š" + (state.tripCurrency || "TWD");
            
            const m = state.members || [];
            document.getElementById('billPayerSelect').innerHTML = m.map(n => `<option value="${n}">${n}</option>`).join('');
            document.getElementById('multiPayerArea').innerHTML = m.map(n => `<div><small>${n}</small><input type="number" class="multi-payer-input" data-name="${n}"></div>`).join('');
            document.getElementById('splitCheckboxes').innerHTML = m.map(n => `<label class="cur-tag active" id="label-${n}"><input type="checkbox" name="splitMember" value="${n}" checked style="display:none;" onchange="document.getElementById('label-${n}').className = this.checked ? 'cur-tag active' : 'cur-tag'">${n}</label>`).join('');
            document.getElementById('memberList').innerHTML = m.map((n, i) => `<span class="cur-tag active">${n} <small onclick="roomData.trips[currentTripId].members.splice(${i},1);db.ref('${DATA_ROOT}/${roomKey}/trips/${currentTripId}/members').set(roomData.trips[currentTripId].members)">Ã—</small></span>`).join('');
            
            let historyHTML = "";
            let lastDate = "";
            const sortedBills = (state.bills || []).slice().reverse();
            sortedBills.forEach((b, i) => {
                const realIdx = state.bills.length - 1 - i;
                const dPart = b.time ? b.time.split(' ')[0] : "æœªçŸ¥æ™‚ç©º";
                if(dPart !== lastDate) {
                    historyHTML += `<div style="text-align: center; margin: 25px 0 15px 0;"><span style="background: rgba(255,255,255,0.7); padding: 5px 15px; border-radius: 50px; font-size: 0.8rem; font-weight: bold; color: var(--primary);">ğŸ—“ï¸ é‚£å¤© ${dPart}</span></div>`;
                    lastDate = dPart;
                }
                historyHTML += `<div class="history-card">
                    <div class="history-header"><span class="history-title">${b.desc}</span><span class="history-amount">${b.amount} <small>${state.tripCurrency}</small></span></div>
                    <div class="history-meta"><span>ğŸ•’ ${b.time ? b.time.split(' ')[1] : ''}</span><span>ğŸ’¬ ${b.note || 'æ²’å¯«è—‰å£'}</span></div>
                    <div class="history-tags">${Object.keys(b.payers).map(p => `<span class="tag-pill payer">ğŸ’³ ${p} ä»˜çš„</span>`).join('')}${b.splitBetween.map(s => `<span class="tag-pill">ğŸ‘¥ ${s} åˆ†æ”¤</span>`).join('')}</div>
                    <div class="history-actions"><button class="action-btn edit-btn" onclick="ui.editBill(${realIdx})">âœï¸ æ”¹ä¸€ä¸‹</button><button class="action-btn del-btn" onclick="api.deleteBill(${realIdx})">ğŸ—‘ï¸ åˆªé™¤</button></div>
                </div>`;
            });
            document.getElementById('historyList').innerHTML = historyHTML || '<p style="text-align:center; color:gray; margin-top:20px;">ç›®å‰å£è¢‹ç©ºç©ºï¼Œé‚„æ²’æ•—å®¶è¨˜éŒ„</p>';

            document.getElementById('archiveList').innerHTML = Object.keys(roomData.archives || {}).map(id => `<div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#f8f9fa; border-radius:10px; margin-bottom:5px; border:1px solid ${id===currentTripId?'var(--primary)':'#eee'}"><span style="font-size:0.85rem; flex:1;">${roomData.archives[id]}</span><div style="display:flex; gap:5px;"><button onclick="roomData.currentTripId='${id}'; db.ref('${DATA_ROOT}/${roomKey}/currentTripId').set('${id}')" style="background:var(--primary); color:white; border:none; border-radius:5px; padding:3px 12px; font-size:0.7rem; cursor:pointer;">è·³è½‰</button></div></div>`).join('');
            document.getElementById('globalSystemList').innerHTML = Object.keys(allRooms).map(k => {
                let d = "æœªçŸ¥ä¸–ç•Œ"; try { d = decodeURIComponent(atob(k)); } catch(e){}
                return `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><strong>${d}</strong><button onclick="api.deleteGlobalRoom('${k}')" style="color:red; border:none; background:none; cursor:pointer;">éŠ·æ¯€</button></div>`;
            }).join('');
            
            const fields = { editRoomPass: roomData.pass, editRoomHint: roomData.hint, editAdminPass: roomData.adminPass, editBgUrl: roomData.config?.bgUrl };
            Object.entries(fields).forEach(([id, val]) => { const el = document.getElementById(id); if(el) el.value = val || ""; });
            document.getElementById('curLabelArea').innerHTML = (roomData.config?.currencies || []).map(c => `<span class="cur-tag active">${c}<span style="margin-left:5px;" onclick="api.deleteCurrency('${c}')">Ã—</span></span>`).join('');

            setTimeout(() => { isRendering = false; }, 100);
        },
        editBill: (idx) => {
            const b = roomData.trips[currentTripId].bills[idx]; editingIdx = idx;
            document.getElementById('billDesc').value = b.desc; document.getElementById('billAmount').value = b.amount; document.getElementById('billNote').value = b.note || "";
            document.querySelectorAll('input[name="splitMember"]').forEach(c => { c.checked = b.splitBetween.includes(c.value); document.getElementById(`label-${c.value}`).className = c.checked ? 'cur-tag active' : 'cur-tag'; });
            if(Object.keys(b.payers).length > 1) { if(!isMultiPayer) togglePayerMode(); document.querySelectorAll('.multi-payer-input').forEach(el => el.value = b.payers[el.dataset.name] || ""); }
            else { if(isMultiPayer) togglePayerMode(); document.getElementById('billPayerSelect').value = Object.keys(b.payers)[0]; }
            document.getElementById('addBillTitle').innerText = "âœï¸ ä¿®æ­£é»‘æ­·å²"; document.getElementById('submitBillBtn').innerText = "æ›´æ–°ç´€éŒ„ â”"; document.getElementById('cancelEditBtn').style.display = "block";
            ui.switchPage('add', document.querySelector('.nav-item'));
        },
        cancelEdit: () => { editingIdx = null; document.getElementById('billDesc').value = ""; document.getElementById('billAmount').value = ""; document.getElementById('billNote').value = ""; document.getElementById('addBillTitle').innerText = "âœï¸ æ•—å®¶ç­†è¨˜"; document.getElementById('submitBillBtn').innerText = "å­˜å…¥æ­·å²æª”æ¡ˆ ğŸ“¥"; document.getElementById('cancelEditBtn').style.display = "none"; },
        toggleAllSplit: (status) => { document.querySelectorAll('input[name="splitMember"]').forEach(c => { c.checked = status; document.getElementById(`label-${c.value}`).className = status ? 'cur-tag active' : 'cur-tag'; }); },
        togglePanel: (id) => { const p = document.getElementById(id); p.style.display = p.style.display === 'block' ? 'none' : 'block'; },
        openNewTripModal: () => { 
            document.getElementById('trip-modal').style.display = 'flex'; 
            api.checkRoom(); 
        },
        calcSettlement: (state) => {
            const members = state.members || []; const bills = state.bills || [];
            const netPaid = {}; members.forEach(m => netPaid[m] = 0);
            bills.forEach(b => {
                Object.entries(b.payers).forEach(([p, a]) => { if(netPaid[p] !== undefined) netPaid[p] += a; });
                if (b.amount === 0 && b.splitBetween.length === 1) {
                    const receiver = b.splitBetween[0]; const settleAmount = Object.values(b.payers)[0];
                    if(netPaid[receiver] !== undefined) netPaid[receiver] -= settleAmount;
                }
            });
            members.forEach(m => { if(netPaid[m] < 0) netPaid[m] = 0; });
            const bal = {}; members.forEach(m => bal[m] = 0);
            bills.forEach(b => {
                Object.entries(b.payers).forEach(([p, a]) => { if(bal[p]!==undefined) bal[p] += a; });
                const share = b.amount / b.splitBetween.length;
                b.splitBetween.forEach(m => { if(bal[m]!==undefined) bal[m] -= share; });
            });
            const debtors = [], creditors = [];
            Object.entries(bal).forEach(([name, balance]) => {
                if (balance < -0.1) debtors.push({ name, amt: -balance });
                else if (balance > 0.1) creditors.push({ name, amt: balance });
            });
            let h = ""; const tempCreditors = JSON.parse(JSON.stringify(creditors));
            debtors.forEach(d => {
                let remaining = d.amt;
                tempCreditors.forEach(c => {
                    if (remaining > 0.1 && c.amt > 0.1) {
                        const pay = Math.min(remaining, c.amt);
                        h += `<div style="padding:12px; background:rgba(255,255,255,0.7); border-radius:15px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee;">
                            <div style="font-size:0.9rem;"><b>${d.name}</b> â” <span style="color:var(--danger); font-weight:900;">${pay.toFixed(1)}</span> â” <b>${c.name}</b></div>
                            <button onclick="ui.partialSettle('${d.name}', '${c.name}', ${pay.toFixed(1)})" style="background:var(--success); color:white; border:none; padding:5px 10px; border-radius:8px; font-size:0.7rem; cursor:pointer;">çµæ¸…</button>
                        </div>`;
                        remaining -= pay; c.amt -= pay;
                    }
                });
            });
            document.getElementById('settlementResult').innerHTML = h || "å¸³ç›®éå¸¸å¹³è¡¡ï¼Œä¸–ç•Œå’Œå¹³ âœ¨";
            if(myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('spendChart'), {
                type: 'doughnut',
                data: { labels: Object.keys(netPaid), datasets: [{ data: Object.values(netPaid), backgroundColor: ['#339af0','#ff922b','#51cf66','#fcc419','#cc5de8','#20c997'] }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        },
        partialSettle: (from, to, amt) => {
            if(!confirm(`ç¢ºèªæ¨™è¨˜ã€Œ${from}ã€æ”¯ä»˜äº†ã€Œ${amt}ã€çµ¦ã€Œ${to}ã€å—ï¼Ÿ`)) return;
            const state = roomData.trips[currentTripId];
            const settleBill = { desc: `âœ… çµæ¸…: ${from}â”${to}`, amount: 0, note: `ç³»çµ±è‡ªå‹•çµæ¸…`, payers: { [from]: amt }, splitBetween: [to], time: new Date().toLocaleString() };
            if(!state.bills) state.bills = []; state.bills.push(settleBill);
            db.ref(`${DATA_ROOT}/${roomKey}/trips/${currentTripId}/bills`).set(state.bills);
        },
        switchPage: (p, el) => { document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active')); document.getElementById('page-'+p).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); },
        settleClick: (el) => { ui.switchPage('settle', el); if(roomData.trips[currentTripId]) ui.calcSettlement(roomData.trips[currentTripId]); },
        accessAdmin: () => { const p = document.getElementById('sysConfigPanel'); if(p.style.display === 'block') { p.style.display = 'none'; return; } const input = prompt("ç®¡ç†æ¬Šé™é©—è­‰ï¼š"); if(input === (roomData.adminPass || "0625")) p.style.display = 'block'; }
    };
</script>
</body>
</html>